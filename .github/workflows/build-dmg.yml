name: Test app.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-deb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Find app.deb
        id: find_deb
        run: |
          DEB_PATH=$(find . -type f -name "app.deb" | head -n 1)
          if [ -z "$DEB_PATH" ]; then
            echo "‚ùå Aucun app.deb trouv√©"
            exit 1
          fi
          echo "‚úÖ app.deb trouv√© : $DEB_PATH"
          echo "deb_path=$DEB_PATH" >> $GITHUB_OUTPUT

      - name: Install dependencies for testing
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Install app.deb
        run: |
          sudo dpkg -i "${{ steps.find_deb.outputs.deb_path }}" || sudo apt-get install -f -y

      - name: Test app launch (headless)
        run: |
          echo "üß™ Test lancement de l'appli install√©e..."
          # Remplace 'app' par le nom exact de ton ex√©cutable install√© (ex: 'monapp')
          timeout 5 xvfb-run -a /usr/local/bin/app &> output.log || true

          if grep -q "Traceback" output.log; then
            echo "‚ùå L'application a plant√© !"
            cat output.log
            exit 1
          else
            echo "‚úÖ Lancement r√©ussi (aucune exception d√©tect√©e)"
          fi
